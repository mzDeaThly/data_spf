{% extends 'base.html' %}
{% block content %}
<h1>แดชบอร์ด</h1>

<!-- การ์ดสรุป -->
<div class="grid">
  <div class="card">จำนวนรถทั้งหมด: <b>{{ counts.vehicles }}</b></div>
  <div class="card">ผู้ใช้ LINE: <b>{{ counts.line_users }}</b></div>
  <div class="card">กลุ่ม LINE: <b>{{ counts.line_groups }}</b></div>
  <div class="card">ผู้ดูแลระบบ: <b>{{ counts.admins }}</b></div>
</div>

<!-- กราฟทั้งหมดใช้กริดแบบ auto-fit + จำกัดความสูง -->
<div class="charts-grid">
  <div class="card chart">
    <h3>จำนวนรถตามยี่ห้อ (Top 8)</h3>
    <div class="chart-wrap"><canvas id="brandChart"></canvas></div>
  </div>

  <div class="card chart">
    <h3>จำนวนรถที่บันทึก (12 เดือนล่าสุด)</h3>
    <div class="chart-wrap"><canvas id="monthChart"></canvas></div>
  </div>

  <div class="card chart">
    <h3>สถานะสิทธิ์ผู้ใช้ LINE</h3>
    <div class="chart-wrap"><canvas id="userPermChart"></canvas></div>
  </div>

  <div class="card chart">
    <h3>สถานะสิทธิ์กลุ่ม LINE</h3>
    <div class="chart-wrap"><canvas id="groupPermChart"></canvas></div>
  </div>

  <div class="card chart" style="grid-column: auto;">
    <h3>จำนวนการค้นหาต่อวัน (14 วัน)</h3>
    <div class="chart-wrap"><canvas id="searchChart"></canvas></div>
  </div>
</div>

<!-- ตาราง Log จำกัดความสูงให้เลื่อนภายใน -->
<div class="card table-scroll">
  <h3 style="margin-top:0">ประวัติการค้นหาล่าสุด</h3>
  <table>
    <thead>
      <tr>
        <th>เวลา (ICT)</th>         <!-- เดิมเขียนว่า UTC -->
        <th>แหล่งที่มา</th>        <!-- group/user (ชื่อที่ตั้งค่า) -->
        <th>ผู้ใช้งาน/ผู้พิมพ์</th> <!-- ชื่อใน LINE -->
        <th>ข้อความค้นหา</th>
        <th>ผลลัพธ์</th>
        <th>สิทธิ์</th>
      </tr>
    </thead>
    <tbody>
    {% for log in recent_logs %}
      {% set st = 'group' if log.source_type in ['group','room'] else 'user' %}
      <tr>
        <!-- แปลงเวลาไทย + ฟอร์แมต dd/mm/yyyy HH:MM -->
        <td data-label="เวลา">
          {{ (log.when.astimezone(tz_bkk)).strftime('%d/%m/%Y %H:%M') }} น.
        </td>

        <!-- แหล่งที่มา: group/user (ชื่อที่ตั้งค่า) -->
        <td data-label="แหล่งที่มา">
          {% if log.context_display_name %}
            {{ st }} ({{ log.context_display_name }})
          {% else %}
            {% if st == 'group' %}
              {{ st }} ({{ (log.line_group_id[:6] ~ '...') if log.line_group_id else '-' }})
            {% else %}
              {{ st }} ({{ (log.line_user_id[:6] ~ '...') if log.line_user_id else '-' }})
            {% endif %}
          {% endif %}
        </td>

        <!-- ผู้ใช้งาน/ผู้พิมพ์: ชื่อใน LINE ถ้าดึงได้ -->
        <td data-label="ผู้ใช้งาน/ผู้พิมพ์">
          {{ log.actor_display_name or ((log.line_user_id[:6] ~ '...') if log.line_user_id else '-') }}
        </td>

        <td data-label="ข้อความค้นหา">{{ log.query_text or '-' }}</td>
        <td data-label="ผลลัพธ์">{{ log.matched if log.matched is not none else '-' }}</td>
        <td data-label="สิทธิ์">{{ 'อนุญาต' if log.allowed else 'ปฏิเสธ' }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ข้อมูลจากฝั่งเซิร์ฟเวอร์
  const brandLabels = {{ brand_labels|tojson }};
  const brandValues = {{ brand_values|tojson }};
  const monthLabels = {{ month_labels|tojson }};
  const monthValues = {{ month_values|tojson }};
  const usersActive = {{ users_active|tojson }};
  const usersInactive = {{ users_inactive|tojson }};
  const groupsActive = {{ groups_active|tojson }};
  const groupsInactive = {{ groups_inactive|tojson }};
  const dayLabels = {{ day_labels|tojson }};
  const dayValues = {{ day_values|tojson }};

  // ตั้งค่าร่วม: ให้กราฟยืดตาม .chart-wrap สูงไม่เกินที่กำหนด
  const opt = { responsive:true, maintainAspectRatio:false };

  new Chart(document.getElementById('brandChart'), {
    type: 'bar',
    data: { labels: brandLabels, datasets: [{ label: 'คัน', data: brandValues }] },
    options: opt
  });

  new Chart(document.getElementById('monthChart'), {
    type: 'line',
    data: { labels: monthLabels, datasets: [{ label: 'คัน/เดือน', data: monthValues, tension:.25 }] },
    options: opt
  });

  new Chart(document.getElementById('userPermChart'), {
    type: 'doughnut',
    data: { labels: ['เปิดใช้งาน','ปิดใช้งาน'], datasets: [{ data: [usersActive, usersInactive] }] },
    options: opt
  });

  new Chart(document.getElementById('groupPermChart'), {
    type: 'doughnut',
    data: { labels: ['เปิดใช้งาน','ปิดใช้งาน'], datasets: [{ data: [groupsActive, groupsInactive] }] },
    options: opt
  });

  new Chart(document.getElementById('searchChart'), {
    type: 'line',
    data: { labels: dayLabels, datasets: [{ label: 'ครั้ง/วัน', data: dayValues, tension:.25 }] },
    options: opt
  });
</script>
{% endblock %}
